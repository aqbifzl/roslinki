services:
  app:
    image: roslinki:prod
    container_name: roslinki
    restart: unless-stopped
    networks:
      - traefik-net
      - roslinki-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.roslinki.rule=Host(`roslinki.mydomain.home`)"
      - "traefik.http.services.roslinki.loadbalancer.server.port=8080"
    environment:
      - HTTP_PORT=8080
      - MQTT_BROKER_URL=ssl://mqtt:8883
      - MQTT_CLIENT_ID=roslinki-server
      - MQTT_USERNAME=user
      - MQTT_PASSWORD=pass
      - MQTT_TLS_INSECURE=true
      - BROADCAST_INTERVAL_SEC=10
      - DB_PATH=/data/roslinki.db
    volumes:
      - ./data:/data
    depends_on:
      - mqtt

  mqtt:
    image: eclipse-mosquitto:latest
    container_name: mqtt
    restart: unless-stopped
    networks:
      - roslinki-net
    ports:
      - "8883:8883"
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf
      - ./passwd:/mosquitto/config/passwd
      - ./certs:/mosquitto/config/certs

networks:
  traefik-net:
    external: true
  roslinki-net:
